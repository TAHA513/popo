<!DOCTYPE html>
<html>
<head>
    <title>Test Image Upload</title>
</head>
<body>
    <h2>Test Profile Image Upload</h2>
    <form id="profileForm" enctype="multipart/form-data">
        <input type="file" id="profileImage" name="image" accept="image/*">
        <button type="submit">Upload Profile Image</button>
    </form>
    
    <h2>Test Cover Image Upload</h2>
    <form id="coverForm" enctype="multipart/form-data">
        <input type="file" id="coverImage" name="image" accept="image/*">
        <button type="submit">Upload Cover Image</button>
    </form>

    <div id="result" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 8px;"></div>
    
    <h2>Test Current User Login</h2>
    <button onclick="testCurrentUser()">Test Current User</button>
    
    <h2>Test Cover Upload Directly</h2>
    <input type="file" id="testCoverFile" accept="image/*">
    <button onclick="testCoverUpload()">Test Cover Upload</button>

    <script>
        // Register and login function
        async function registerAndLogin() {
            // Try to register first
            const registerData = {
                username: 'testuser' + Date.now(),
                password: '123456',
                confirmPassword: '123456',
                firstName: 'Test',
                lastName: 'User',
                email: 'test' + Date.now() + '@example.com'
            };
            
            try {
                const registerResponse = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });
                
                const registerResult = await registerResponse.json();
                console.log('Register result:', registerResult);
            } catch (error) {
                console.log('Register error:', error);
            }
            
            // Login with the same credentials
            const loginResponse = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: registerData.username,
                    password: registerData.password
                })
            });
            
            const loginResult = await loginResponse.json();
            console.log('Login result:', loginResult);
            return loginResult;
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Register and login first
            await registerAndLogin();
            
            const formData = new FormData();
            const fileInput = document.getElementById('profileImage');
            formData.append('image', fileInput.files[0]);

            try {
                const response = await fetch('/api/upload/profile-image', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                document.getElementById('result').innerHTML = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('result').innerHTML = 'Error: ' + error.message;
            }
        });

        document.getElementById('coverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Register and login first
            await registerAndLogin();
            
            const formData = new FormData();
            const fileInput = document.getElementById('coverImage');
            formData.append('image', fileInput.files[0]);

            try {
                const response = await fetch('/api/upload/cover-image', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                document.getElementById('result').innerHTML = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('result').innerHTML = 'Error: ' + error.message;
            }
        });
        
        // Test current user function
        async function testCurrentUser() {
            try {
                const response = await fetch('/api/auth/user', {
                    credentials: 'include'
                });
                const result = await response.json();
                document.getElementById('result').innerHTML = '<h3>Current User:</h3><pre>' + JSON.stringify(result, null, 2) + '</pre>';
            } catch (error) {
                document.getElementById('result').innerHTML = '<h3>Error:</h3>' + error.message;
            }
        }
        
        // Test cover upload directly
        async function testCoverUpload() {
            await registerAndLogin();
            
            const fileInput = document.getElementById('testCoverFile');
            if (!fileInput.files[0]) {
                document.getElementById('result').innerHTML = 'Please select a file first';
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            try {
                console.log('Starting cover upload...');
                const response = await fetch('/api/upload/cover-image', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Cover upload result:', result);
                
                document.getElementById('result').innerHTML = '<h3>Cover Upload Result:</h3><pre>' + JSON.stringify(result, null, 2) + '</pre>';
                
                if (result.success) {
                    document.getElementById('result').innerHTML += '<br><img src="' + result.coverImageUrl + '" style="max-width: 300px; margin-top: 10px;">';
                }
            } catch (error) {
                console.error('Cover upload error:', error);
                document.getElementById('result').innerHTML = '<h3>Cover Upload Error:</h3>' + error.message;
            }
        }
    </script>
</body>
</html>