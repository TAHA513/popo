<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الحل النهائي لتثبيت PWA - LaaBoBo Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ec4899 0%, #9333ea 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .step {
            background: rgba(255, 255, 255, 0.15);
            margin: 20px 0;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .step:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .step h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #fef9c3;
        }
        button {
            width: 100%;
            padding: 15px 25px;
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            color: #9333ea;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }
        button:active {
            transform: translateY(0);
        }
        .log {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #10b981; }
        .status.error { background: #ef4444; }
        .status.warning { background: #f59e0b; }
        .status.info { background: #3b82f6; }
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 5px solid #fef9c3;
        }
        .instructions h4 {
            color: #fef9c3;
            margin-bottom: 10px;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo svg {
            width: 120px;
            height: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg width="120" height="80" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#fef9c3;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="70" cy="100" r="60" fill="url(#logoGrad)" opacity="0.9"/>
                <ellipse cx="55" cy="75" rx="6" ry="18" fill="#ec4899" transform="rotate(-20 55 75)" />
                <ellipse cx="85" cy="75" rx="6" ry="18" fill="#ec4899" transform="rotate(20 85 75)" />
                <circle cx="70" cy="100" r="25" fill="#9333ea" />
                <text x="150" y="90" font-family="Arial" font-size="22" font-weight="bold" fill="white">LaaBoBo</text>
                <text x="170" y="115" font-family="Arial" font-size="14" fill="#fef9c3">Live</text>
            </svg>
        </div>
        
        <h1>🔧 الحل النهائي لتثبيت PWA</h1>
        
        <div class="step">
            <h3>المرحلة 1: التشخيص الشامل</h3>
            <button onclick="diagnoseSystem()">🔍 فحص النظام والمتطلبات</button>
        </div>

        <div class="step">
            <h3>المرحلة 2: المسح الجذري</h3>
            <button onclick="performRadicalCleanup()">🧹 مسح جذري للبيانات القديمة</button>
        </div>

        <div class="step">
            <h3>المرحلة 3: إعادة البناء</h3>
            <button onclick="rebuildPWA()">🔨 إعادة بناء PWA من الصفر</button>
        </div>

        <div class="step">
            <h3>المرحلة 4: التفعيل النهائي</h3>
            <button onclick="activatePWA()">🚀 تفعيل PWA وتثبيت التطبيق</button>
        </div>

        <div class="log" id="systemLog">جاري الاستعداد لإصلاح PWA...</div>

        <div class="instructions">
            <h4>📋 تعليمات الاستخدام:</h4>
            <ul>
                <li>اتبع المراحل بالترتيب الصحيح</li>
                <li>انتظر اكتمال كل مرحلة قبل الانتقال للتالية</li>
                <li>راقب الرسائل في شاشة السجل</li>
                <li>بعد المرحلة 4 ستجد "تثبيت LaaBoBo Live" في المتصفح</li>
            </ul>
        </div>
    </div>

    <script>
        const log = document.getElementById('systemLog');
        let currentStep = 0;
        
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: '📝',
                progress: '🔄'
            };
            
            log.textContent += `${timestamp} ${icons[type]} ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function diagnoseSystem() {
            if (currentStep !== 0) {
                addToLog('يجب البدء من المرحلة 1', 'warning');
                return;
            }
            
            addToLog('🔍 بدء التشخيص الشامل للنظام...', 'progress');
            
            // Check PWA support
            const pwaSupport = {
                serviceWorker: 'serviceWorker' in navigator,
                manifest: 'manifest' in document.createElement('link'),
                pushNotifications: 'PushManager' in window,
                caches: 'caches' in window
            };
            
            for (const [feature, supported] of Object.entries(pwaSupport)) {
                addToLog(`${feature}: ${supported ? 'مدعوم' : 'غير مدعوم'}`, supported ? 'success' : 'error');
            }
            
            // Test manifest
            try {
                const response = await fetch('/manifest.json?v=' + Date.now(), { cache: 'no-cache' });
                if (response.ok) {
                    const manifest = await response.json();
                    addToLog(`✅ Manifest محمل: "${manifest.name}"`, 'success');
                    addToLog(`📱 عدد الأيقونات: ${manifest.icons.length}`, 'info');
                } else {
                    addToLog(`❌ خطأ في Manifest: ${response.status}`, 'error');
                }
            } catch (error) {
                addToLog(`❌ فشل تحميل Manifest: ${error.message}`, 'error');
            }
            
            // Check existing service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                addToLog(`🔧 وجدت ${registrations.length} service workers مسجلة`, 'info');
            }
            
            // Check caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                addToLog(`💾 وجدت ${cacheNames.length} caches محفوظة`, 'info');
            }
            
            addToLog('✅ تم التشخيص بنجاح - يمكن المتابعة للمرحلة 2', 'success');
            currentStep = 1;
        }

        async function performRadicalCleanup() {
            if (currentStep !== 1) {
                addToLog('يجب إكمال المرحلة 1 أولاً', 'warning');
                return;
            }
            
            addToLog('🧹 بدء المسح الجذري...', 'progress');
            
            try {
                // Unregister ALL service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        addToLog(`🗑️ تم إلغاء: ${registration.scope}`, 'success');
                    }
                    
                    // Clear controller
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ action: 'skipWaiting' });
                        addToLog('🔄 تم إجبار تحديث Service Worker', 'success');
                    }
                }
                
                // Clear ALL caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        addToLog(`💾 تم حذف cache: ${cacheName}`, 'success');
                    }
                }
                
                // Clear storage
                localStorage.clear();
                sessionStorage.clear();
                addToLog('🧽 تم مسح جميع البيانات المحلية', 'success');
                
                // Clear IndexedDB
                try {
                    const databases = await indexedDB.databases?.() || [];
                    for (const db of databases) {
                        if (db.name) {
                            indexedDB.deleteDatabase(db.name);
                            addToLog(`🗂️ تم حذف قاعدة بيانات: ${db.name}`, 'success');
                        }
                    }
                } catch (e) {
                    addToLog(`⚠️ تعذر مسح IndexedDB: ${e.message}`, 'warning');
                }
                
                addToLog('✅ تم المسح الجذري - المتابعة للمرحلة 3', 'success');
                currentStep = 2;
                
            } catch (error) {
                addToLog(`❌ خطأ في المسح: ${error.message}`, 'error');
            }
        }

        async function rebuildPWA() {
            if (currentStep !== 2) {
                addToLog('يجب إكمال المرحلة 2 أولاً', 'warning');
                return;
            }
            
            addToLog('🔨 بدء إعادة بناء PWA...', 'progress');
            
            try {
                // Force reload manifest
                const manifestResponse = await fetch('/manifest.json?v=' + Date.now() + '&rebuild=1', {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (manifestResponse.ok) {
                    const manifest = await manifestResponse.json();
                    addToLog(`📄 تم تحميل Manifest جديد: ${manifest.name}`, 'success');
                    
                    // Verify all icons
                    let iconErrors = 0;
                    for (const icon of manifest.icons) {
                        try {
                            const iconResponse = await fetch(icon.src, { cache: 'no-cache' });
                            if (iconResponse.ok) {
                                addToLog(`🎨 أيقونة ${icon.sizes}: متوفرة`, 'success');
                            } else {
                                addToLog(`❌ أيقونة ${icon.sizes}: مفقودة`, 'error');
                                iconErrors++;
                            }
                        } catch (e) {
                            addToLog(`❌ خطأ في أيقونة ${icon.sizes}: ${e.message}`, 'error');
                            iconErrors++;
                        }
                    }
                    
                    if (iconErrors === 0) {
                        addToLog('✅ جميع الأيقونات متوفرة وصحيحة', 'success');
                    } else {
                        addToLog(`⚠️ وجدت ${iconErrors} أيقونات مفقودة`, 'warning');
                    }
                    
                    // Register new service worker
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.register('/sw.js?v=' + Date.now(), {
                            scope: '/',
                            updateViaCache: 'none'
                        });
                        
                        addToLog('🔧 تم تسجيل Service Worker جديد', 'success');
                        
                        // Wait for activation
                        await new Promise((resolve) => {
                            if (registration.active) {
                                resolve(true);
                            } else {
                                registration.addEventListener('updatefound', () => {
                                    const newWorker = registration.installing;
                                    if (newWorker) {
                                        newWorker.addEventListener('statechange', () => {
                                            if (newWorker.state === 'activated') {
                                                resolve(true);
                                            }
                                        });
                                    }
                                });
                            }
                            setTimeout(resolve, 3000); // Fallback timeout
                        });
                        
                        addToLog('⚡ Service Worker نشط ويعمل', 'success');
                    }
                    
                    addToLog('✅ تم إعادة البناء - المتابعة للمرحلة 4', 'success');
                    currentStep = 3;
                    
                } else {
                    addToLog(`❌ فشل تحميل Manifest: ${manifestResponse.status}`, 'error');
                }
                
            } catch (error) {
                addToLog(`❌ خطأ في إعادة البناء: ${error.message}`, 'error');
            }
        }

        async function activatePWA() {
            if (currentStep !== 3) {
                addToLog('يجب إكمال المرحلة 3 أولاً', 'warning');
                return;
            }
            
            addToLog('🚀 بدء تفعيل PWA النهائي...', 'progress');
            
            // Check PWA installability
            let installable = false;
            
            // Listen for install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                installable = true;
                addToLog('📲 PWA جاهز للتثبيت!', 'success');
            });
            
            // Wait a moment for the prompt
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            if (installable) {
                addToLog('🎉 PWA قابل للتثبيت الآن!', 'success');
            } else {
                addToLog('🔄 جاري التحقق من قابلية التثبيت...', 'progress');
            }
            
            // Final verification
            try {
                const manifest = await (await fetch('/manifest.json?final=1', { cache: 'no-cache' })).json();
                const swRegistration = await navigator.serviceWorker.ready;
                
                addToLog('📄 Manifest نهائي محمل بنجاح', 'success');
                addToLog('⚙️ Service Worker جاهز ونشط', 'success');
                
                // Success message
                addToLog('', 'info');
                addToLog('🎊 تم إعداد PWA بنجاح!', 'success');
                addToLog('', 'info');
                addToLog('📱 للتثبيت:', 'info');
                addToLog('• Chrome: الإعدادات ⋮ → تثبيت LaaBoBo Live', 'info');
                addToLog('• Safari: مشاركة → إضافة إلى الشاشة الرئيسية', 'info');
                addToLog('• Edge: الإعدادات ... → التطبيقات → تثبيت هذا الموقع', 'info');
                addToLog('', 'info');
                
                // Navigate to main app after delay
                setTimeout(() => {
                    addToLog('🔄 الانتقال للتطبيق الرئيسي...', 'progress');
                    window.location.href = '/?pwa_activated=1&t=' + Date.now();
                }, 5000);
                
                currentStep = 4;
                
            } catch (error) {
                addToLog(`❌ خطأ في التفعيل النهائي: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            addToLog('🎯 نظام إصلاح PWA جاهز للعمل', 'info');
            addToLog('👆 ابدأ بالمرحلة 1: التشخيص الشامل', 'info');
        });
    </script>
</body>
</html>