<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ØªØ«Ø¨ÙŠØª PWA - LaaBoBo Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ec4899 0%, #9333ea 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .step {
            background: rgba(255, 255, 255, 0.15);
            margin: 20px 0;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .step:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .step h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #fef9c3;
        }
        button {
            width: 100%;
            padding: 15px 25px;
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            color: #9333ea;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }
        button:active {
            transform: translateY(0);
        }
        .log {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #10b981; }
        .status.error { background: #ef4444; }
        .status.warning { background: #f59e0b; }
        .status.info { background: #3b82f6; }
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 5px solid #fef9c3;
        }
        .instructions h4 {
            color: #fef9c3;
            margin-bottom: 10px;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo svg {
            width: 120px;
            height: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg width="120" height="80" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#fef9c3;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="70" cy="100" r="60" fill="url(#logoGrad)" opacity="0.9"/>
                <ellipse cx="55" cy="75" rx="6" ry="18" fill="#ec4899" transform="rotate(-20 55 75)" />
                <ellipse cx="85" cy="75" rx="6" ry="18" fill="#ec4899" transform="rotate(20 85 75)" />
                <circle cx="70" cy="100" r="25" fill="#9333ea" />
                <text x="150" y="90" font-family="Arial" font-size="22" font-weight="bold" fill="white">LaaBoBo</text>
                <text x="170" y="115" font-family="Arial" font-size="14" fill="#fef9c3">Live</text>
            </svg>
        </div>
        
        <h1>ğŸ”§ Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ØªØ«Ø¨ÙŠØª PWA</h1>
        
        <div class="step">
            <h3>Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„</h3>
            <button onclick="diagnoseSystem()">ğŸ” ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª</button>
        </div>

        <div class="step">
            <h3>Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¬Ø°Ø±ÙŠ</h3>
            <button onclick="performRadicalCleanup()">ğŸ§¹ Ù…Ø³Ø­ Ø¬Ø°Ø±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</button>
        </div>

        <div class="step">
            <h3>Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡</h3>
            <button onclick="rebuildPWA()">ğŸ”¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ PWA Ù…Ù† Ø§Ù„ØµÙØ±</button>
        </div>

        <div class="step">
            <h3>Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
            <button onclick="activatePWA()">ğŸš€ ØªÙØ¹ÙŠÙ„ PWA ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        </div>

        <div class="log" id="systemLog">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ø¥ØµÙ„Ø§Ø­ PWA...</div>

        <div class="instructions">
            <h4>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h4>
            <ul>
                <li>Ø§ØªØ¨Ø¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­</li>
                <li>Ø§Ù†ØªØ¸Ø± Ø§ÙƒØªÙ…Ø§Ù„ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ§Ù„ÙŠØ©</li>
                <li>Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø¬Ù„</li>
                <li>Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4 Ø³ØªØ¬Ø¯ "ØªØ«Ø¨ÙŠØª LaaBoBo Live" ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­</li>
            </ul>
        </div>
    </div>

    <script>
        const log = document.getElementById('systemLog');
        let currentStep = 0;
        
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'ğŸ“',
                progress: 'ğŸ”„'
            };
            
            log.textContent += `${timestamp} ${icons[type]} ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function diagnoseSystem() {
            if (currentStep !== 0) {
                addToLog('ÙŠØ¬Ø¨ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1', 'warning');
                return;
            }
            
            addToLog('ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù…...', 'progress');
            
            // Check PWA support
            const pwaSupport = {
                serviceWorker: 'serviceWorker' in navigator,
                manifest: 'manifest' in document.createElement('link'),
                pushNotifications: 'PushManager' in window,
                caches: 'caches' in window
            };
            
            for (const [feature, supported] of Object.entries(pwaSupport)) {
                addToLog(`${feature}: ${supported ? 'Ù…Ø¯Ø¹ÙˆÙ…' : 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'}`, supported ? 'success' : 'error');
            }
            
            // Test manifest
            try {
                const response = await fetch('/manifest.json?v=' + Date.now(), { cache: 'no-cache' });
                if (response.ok) {
                    const manifest = await response.json();
                    addToLog(`âœ… Manifest Ù…Ø­Ù…Ù„: "${manifest.name}"`, 'success');
                    addToLog(`ğŸ“± Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª: ${manifest.icons.length}`, 'info');
                } else {
                    addToLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Manifest: ${response.status}`, 'error');
                }
            } catch (error) {
                addToLog(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Manifest: ${error.message}`, 'error');
            }
            
            // Check existing service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                addToLog(`ğŸ”§ ÙˆØ¬Ø¯Øª ${registrations.length} service workers Ù…Ø³Ø¬Ù„Ø©`, 'info');
            }
            
            // Check caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                addToLog(`ğŸ’¾ ÙˆØ¬Ø¯Øª ${cacheNames.length} caches Ù…Ø­ÙÙˆØ¸Ø©`, 'info');
            }
            
            addToLog('âœ… ØªÙ… Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­ - ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø±Ø­Ù„Ø© 2', 'success');
            currentStep = 1;
        }

        async function performRadicalCleanup() {
            if (currentStep !== 1) {
                addToLog('ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            addToLog('ğŸ§¹ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¬Ø°Ø±ÙŠ...', 'progress');
            
            try {
                // Unregister ALL service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        addToLog(`ğŸ—‘ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡: ${registration.scope}`, 'success');
                    }
                    
                    // Clear controller
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ action: 'skipWaiting' });
                        addToLog('ğŸ”„ ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Service Worker', 'success');
                    }
                }
                
                // Clear ALL caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        addToLog(`ğŸ’¾ ØªÙ… Ø­Ø°Ù cache: ${cacheName}`, 'success');
                    }
                }
                
                // Clear storage
                localStorage.clear();
                sessionStorage.clear();
                addToLog('ğŸ§½ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'success');
                
                // Clear IndexedDB
                try {
                    const databases = await indexedDB.databases?.() || [];
                    for (const db of databases) {
                        if (db.name) {
                            indexedDB.deleteDatabase(db.name);
                            addToLog(`ğŸ—‚ï¸ ØªÙ… Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª: ${db.name}`, 'success');
                        }
                    }
                } catch (e) {
                    addToLog(`âš ï¸ ØªØ¹Ø°Ø± Ù…Ø³Ø­ IndexedDB: ${e.message}`, 'warning');
                }
                
                addToLog('âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¬Ø°Ø±ÙŠ - Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø±Ø­Ù„Ø© 3', 'success');
                currentStep = 2;
                
            } catch (error) {
                addToLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ${error.message}`, 'error');
            }
        }

        async function rebuildPWA() {
            if (currentStep !== 2) {
                addToLog('ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            addToLog('ğŸ”¨ Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ PWA...', 'progress');
            
            try {
                // Force reload manifest
                const manifestResponse = await fetch('/manifest.json?v=' + Date.now() + '&rebuild=1', {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (manifestResponse.ok) {
                    const manifest = await manifestResponse.json();
                    addToLog(`ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Manifest Ø¬Ø¯ÙŠØ¯: ${manifest.name}`, 'success');
                    
                    // Verify all icons
                    let iconErrors = 0;
                    for (const icon of manifest.icons) {
                        try {
                            const iconResponse = await fetch(icon.src, { cache: 'no-cache' });
                            if (iconResponse.ok) {
                                addToLog(`ğŸ¨ Ø£ÙŠÙ‚ÙˆÙ†Ø© ${icon.sizes}: Ù…ØªÙˆÙØ±Ø©`, 'success');
                            } else {
                                addToLog(`âŒ Ø£ÙŠÙ‚ÙˆÙ†Ø© ${icon.sizes}: Ù…ÙÙ‚ÙˆØ¯Ø©`, 'error');
                                iconErrors++;
                            }
                        } catch (e) {
                            addToLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø£ÙŠÙ‚ÙˆÙ†Ø© ${icon.sizes}: ${e.message}`, 'error');
                            iconErrors++;
                        }
                    }
                    
                    if (iconErrors === 0) {
                        addToLog('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…ØªÙˆÙØ±Ø© ÙˆØµØ­ÙŠØ­Ø©', 'success');
                    } else {
                        addToLog(`âš ï¸ ÙˆØ¬Ø¯Øª ${iconErrors} Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©`, 'warning');
                    }
                    
                    // Register new service worker
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.register('/sw.js?v=' + Date.now(), {
                            scope: '/',
                            updateViaCache: 'none'
                        });
                        
                        addToLog('ğŸ”§ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¬Ø¯ÙŠØ¯', 'success');
                        
                        // Wait for activation
                        await new Promise((resolve) => {
                            if (registration.active) {
                                resolve(true);
                            } else {
                                registration.addEventListener('updatefound', () => {
                                    const newWorker = registration.installing;
                                    if (newWorker) {
                                        newWorker.addEventListener('statechange', () => {
                                            if (newWorker.state === 'activated') {
                                                resolve(true);
                                            }
                                        });
                                    }
                                });
                            }
                            setTimeout(resolve, 3000); // Fallback timeout
                        });
                        
                        addToLog('âš¡ Service Worker Ù†Ø´Ø· ÙˆÙŠØ¹Ù…Ù„', 'success');
                    }
                    
                    addToLog('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø±Ø­Ù„Ø© 4', 'success');
                    currentStep = 3;
                    
                } else {
                    addToLog(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Manifest: ${manifestResponse.status}`, 'error');
                }
                
            } catch (error) {
                addToLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡: ${error.message}`, 'error');
            }
        }

        async function activatePWA() {
            if (currentStep !== 3) {
                addToLog('ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3 Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            addToLog('ğŸš€ Ø¨Ø¯Ø¡ ØªÙØ¹ÙŠÙ„ PWA Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...', 'progress');
            
            // Check PWA installability
            let installable = false;
            
            // Listen for install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                installable = true;
                addToLog('ğŸ“² PWA Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª!', 'success');
            });
            
            // Wait a moment for the prompt
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            if (installable) {
                addToLog('ğŸ‰ PWA Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù†!', 'success');
            } else {
                addToLog('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª...', 'progress');
            }
            
            // Final verification
            try {
                const manifest = await (await fetch('/manifest.json?final=1', { cache: 'no-cache' })).json();
                const swRegistration = await navigator.serviceWorker.ready;
                
                addToLog('ğŸ“„ Manifest Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø­Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                addToLog('âš™ï¸ Service Worker Ø¬Ø§Ù‡Ø² ÙˆÙ†Ø´Ø·', 'success');
                
                // Success message
                addToLog('', 'info');
                addToLog('ğŸŠ ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ PWA Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                addToLog('', 'info');
                addToLog('ğŸ“± Ù„Ù„ØªØ«Ø¨ÙŠØª:', 'info');
                addToLog('â€¢ Chrome: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â‹® â†’ ØªØ«Ø¨ÙŠØª LaaBoBo Live', 'info');
                addToLog('â€¢ Safari: Ù…Ø´Ø§Ø±ÙƒØ© â†’ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'info');
                addToLog('â€¢ Edge: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ... â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'info');
                addToLog('', 'info');
                
                // Navigate to main app after delay
                setTimeout(() => {
                    addToLog('ğŸ”„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...', 'progress');
                    window.location.href = '/?pwa_activated=1&t=' + Date.now();
                }, 5000);
                
                currentStep = 4;
                
            } catch (error) {
                addToLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            addToLog('ğŸ¯ Ù†Ø¸Ø§Ù… Ø¥ØµÙ„Ø§Ø­ PWA Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„', 'info');
            addToLog('ğŸ‘† Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„', 'info');
        });
    </script>
</body>
</html>