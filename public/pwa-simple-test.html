<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار PWA - LaaBoBo Live</title>
    <link rel="manifest" href="/manifest.json?v=9.0&force_new=true">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(45deg, #ec4899, #9333ea);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        button {
            background: white;
            color: #9333ea;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            width: 100%;
        }
        button:hover {
            background: #f0f0f0;
        }
        .log {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 3px;
            display: inline-block;
        }
        .success { background: #10b981; }
        .error { background: #ef4444; }
        .warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 اختبار PWA السريع</h1>
        
        <button onclick="testManifest()">🔍 اختبار Manifest</button>
        <button onclick="testServiceWorker()">⚙️ اختبار Service Worker</button>
        <button onclick="testPWACriteria()">📋 فحص معايير PWA</button>
        <button onclick="forceInstallPrompt()">📱 إجبار ظهور زر التثبيت</button>
        <button onclick="clearEverything()">🗑️ مسح كامل</button>
        
        <div class="log" id="testLog">جاري التحضير للاختبار...</div>
        
        <div style="margin-top: 20px;">
            <a href="/" style="color: #fef9c3; text-decoration: none;">← العودة للتطبيق الرئيسي</a>
        </div>
    </div>

    <script>
        const log = document.getElementById('testLog');
        let installPromptEvent = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const icons = { success: '✅', error: '❌', warning: '⚠️', info: '📝' };
            log.textContent += `${timestamp} ${icons[type]} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        // Capture install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            installPromptEvent = e;
            addLog('PWA Install Prompt متوفر!', 'success');
            addLog('يمكنك الآن الضغط على "إجبار ظهور زر التثبيت"', 'info');
        });

        async function testManifest() {
            addLog('🔍 اختبار Manifest...', 'info');
            
            try {
                const response = await fetch('/manifest.json?v=' + Date.now(), {
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const manifest = await response.json();
                    addLog(`✅ Manifest محمل: ${manifest.name}`, 'success');
                    addLog(`📱 Short name: ${manifest.short_name}`, 'info');
                    addLog(`🎨 Display: ${manifest.display}`, 'info');
                    addLog(`🌟 Start URL: ${manifest.start_url}`, 'info');
                    addLog(`🎯 Icons count: ${manifest.icons.length}`, 'info');
                    
                    // Test each icon
                    for (const icon of manifest.icons) {
                        try {
                            const iconResponse = await fetch(icon.src, { cache: 'no-cache' });
                            if (iconResponse.ok) {
                                addLog(`✅ Icon ${icon.sizes}: موجود`, 'success');
                            } else {
                                addLog(`❌ Icon ${icon.sizes}: مفقود (${iconResponse.status})`, 'error');
                            }
                        } catch (e) {
                            addLog(`❌ Icon ${icon.sizes}: خطأ ${e.message}`, 'error');
                        }
                    }
                } else {
                    addLog(`❌ فشل تحميل Manifest: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`❌ خطأ في Manifest: ${error.message}`, 'error');
            }
        }

        async function testServiceWorker() {
            addLog('⚙️ اختبار Service Worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                addLog('✅ Service Worker مدعوم', 'success');
                
                try {
                    // Get existing registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    addLog(`📋 وجدت ${registrations.length} registrations`, 'info');
                    
                    // Register new service worker
                    const registration = await navigator.serviceWorker.register('/sw.js?v=' + Date.now(), {
                        scope: '/',
                        updateViaCache: 'none'
                    });
                    
                    addLog('✅ Service Worker مسجل بنجاح', 'success');
                    
                    // Check state
                    if (registration.active) {
                        addLog('🟢 Service Worker نشط', 'success');
                    } else if (registration.installing) {
                        addLog('🔄 Service Worker قيد التثبيت...', 'info');
                    } else if (registration.waiting) {
                        addLog('⏳ Service Worker في الانتظار', 'warning');
                    }
                    
                    // Wait for ready
                    await navigator.serviceWorker.ready;
                    addLog('🎯 Service Worker جاهز!', 'success');
                    
                } catch (error) {
                    addLog(`❌ خطأ في Service Worker: ${error.message}`, 'error');
                }
            } else {
                addLog('❌ Service Worker غير مدعوم', 'error');
            }
        }

        async function testPWACriteria() {
            addLog('📋 فحص معايير PWA...', 'info');
            
            const criteria = {
                'HTTPS': location.protocol === 'https:',
                'Service Worker': 'serviceWorker' in navigator,
                'Web Manifest': document.querySelector('link[rel="manifest"]') !== null,
                'Icons': false,
                'Display Mode': false,
                'Start URL': false
            };
            
            // Test manifest details
            try {
                const manifestResponse = await fetch('/manifest.json', { cache: 'no-cache' });
                if (manifestResponse.ok) {
                    const manifest = await manifestResponse.json();
                    criteria['Icons'] = manifest.icons && manifest.icons.length >= 2;
                    criteria['Display Mode'] = manifest.display === 'standalone';
                    criteria['Start URL'] = !!manifest.start_url;
                }
            } catch (e) {
                addLog(`⚠️ لا يمكن فحص Manifest: ${e.message}`, 'warning');
            }
            
            // Display results
            for (const [criterion, passed] of Object.entries(criteria)) {
                const status = passed ? 'success' : 'error';
                const icon = passed ? '✅' : '❌';
                addLog(`${icon} ${criterion}: ${passed ? 'يتطابق' : 'لا يتطابق'}`, status);
            }
            
            const passedCount = Object.values(criteria).filter(Boolean).length;
            const totalCount = Object.keys(criteria).length;
            
            if (passedCount === totalCount) {
                addLog('🎉 يتطابق مع جميع معايير PWA!', 'success');
                addLog('💡 يجب أن يظهر زر التثبيت في المتصفح', 'info');
            } else {
                addLog(`⚠️ يتطابق مع ${passedCount}/${totalCount} معايير`, 'warning');
            }
        }

        async function forceInstallPrompt() {
            addLog('📱 محاولة إجبار ظهور زر التثبيت...', 'info');
            
            if (installPromptEvent) {
                try {
                    const result = await installPromptEvent.prompt();
                    addLog('🎯 تم عرض prompt للتثبيت', 'success');
                    
                    const choiceResult = await result.userChoice;
                    if (choiceResult.outcome === 'accepted') {
                        addLog('✅ المستخدم وافق على التثبيت!', 'success');
                    } else {
                        addLog('⏸️ المستخدم رفض التثبيت', 'info');
                    }
                    installPromptEvent = null;
                } catch (error) {
                    addLog(`❌ خطأ في Install Prompt: ${error.message}`, 'error');
                }
            } else {
                addLog('❌ Install Prompt غير متوفر', 'error');
                addLog('💡 تأكد من تطابق معايير PWA أولاً', 'info');
                
                // Try to trigger by reloading
                addLog('🔄 جاري إعادة التحميل لتحفيز Install Prompt...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

        async function clearEverything() {
            addLog('🗑️ مسح جميع البيانات...', 'info');
            
            try {
                // Unregister service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        addLog(`✅ تم إلغاء: ${registration.scope}`, 'success');
                    }
                }
                
                // Clear caches
                const cacheNames = await caches.keys();
                for (let cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    addLog(`✅ تم حذف cache: ${cacheName}`, 'success');
                }
                
                // Clear storage
                localStorage.clear();
                sessionStorage.clear();
                addLog('✅ تم مسح Storage', 'success');
                
                addLog('🔄 إعادة تحميل الصفحة...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                addLog(`❌ خطأ في المسح: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            addLog('🎯 صفحة اختبار PWA جاهزة', 'info');
            addLog('👆 ابدأ بـ "اختبار Manifest" ثم "فحص معايير PWA"', 'info');
        });

        // Listen for app installed
        window.addEventListener('appinstalled', (evt) => {
            addLog('🎉 تم تثبيت التطبيق بنجاح!', 'success');
        });
    </script>
</body>
</html>