<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± PWA - LaaBoBo Live</title>
    <link rel="manifest" href="/manifest.json?v=9.0&force_new=true">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(45deg, #ec4899, #9333ea);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        button {
            background: white;
            color: #9333ea;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            width: 100%;
        }
        button:hover {
            background: #f0f0f0;
        }
        .log {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 3px;
            display: inline-block;
        }
        .success { background: #10b981; }
        .error { background: #ef4444; }
        .warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± PWA Ø§Ù„Ø³Ø±ÙŠØ¹</h1>
        
        <button onclick="testManifest()">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Manifest</button>
        <button onclick="testServiceWorker()">âš™ï¸ Ø§Ø®ØªØ¨Ø§Ø± Service Worker</button>
        <button onclick="testPWACriteria()">ğŸ“‹ ÙØ­Øµ Ù…Ø¹Ø§ÙŠÙŠØ± PWA</button>
        <button onclick="forceInstallPrompt()">ğŸ“± Ø¥Ø¬Ø¨Ø§Ø± Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª</button>
        <button onclick="clearEverything()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒØ§Ù…Ù„</button>
        
        <div class="log" id="testLog">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...</div>
        
        <div style="margin-top: 20px;">
            <a href="/" style="color: #fef9c3; text-decoration: none;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</a>
        </div>
    </div>

    <script>
        const log = document.getElementById('testLog');
        let installPromptEvent = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'ğŸ“' };
            log.textContent += `${timestamp} ${icons[type]} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        // Capture install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            installPromptEvent = e;
            addLog('PWA Install Prompt Ù…ØªÙˆÙØ±!', 'success');
            addLog('ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¬Ø¨Ø§Ø± Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª"', 'info');
        });

        async function testManifest() {
            addLog('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Manifest...', 'info');
            
            try {
                const response = await fetch('/manifest.json?v=' + Date.now(), {
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const manifest = await response.json();
                    addLog(`âœ… Manifest Ù…Ø­Ù…Ù„: ${manifest.name}`, 'success');
                    addLog(`ğŸ“± Short name: ${manifest.short_name}`, 'info');
                    addLog(`ğŸ¨ Display: ${manifest.display}`, 'info');
                    addLog(`ğŸŒŸ Start URL: ${manifest.start_url}`, 'info');
                    addLog(`ğŸ¯ Icons count: ${manifest.icons.length}`, 'info');
                    
                    // Test each icon
                    for (const icon of manifest.icons) {
                        try {
                            const iconResponse = await fetch(icon.src, { cache: 'no-cache' });
                            if (iconResponse.ok) {
                                addLog(`âœ… Icon ${icon.sizes}: Ù…ÙˆØ¬ÙˆØ¯`, 'success');
                            } else {
                                addLog(`âŒ Icon ${icon.sizes}: Ù…ÙÙ‚ÙˆØ¯ (${iconResponse.status})`, 'error');
                            }
                        } catch (e) {
                            addLog(`âŒ Icon ${icon.sizes}: Ø®Ø·Ø£ ${e.message}`, 'error');
                        }
                    }
                } else {
                    addLog(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Manifest: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Manifest: ${error.message}`, 'error');
            }
        }

        async function testServiceWorker() {
            addLog('âš™ï¸ Ø§Ø®ØªØ¨Ø§Ø± Service Worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                addLog('âœ… Service Worker Ù…Ø¯Ø¹ÙˆÙ…', 'success');
                
                try {
                    // Get existing registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    addLog(`ğŸ“‹ ÙˆØ¬Ø¯Øª ${registrations.length} registrations`, 'info');
                    
                    // Register new service worker
                    const registration = await navigator.serviceWorker.register('/sw.js?v=' + Date.now(), {
                        scope: '/',
                        updateViaCache: 'none'
                    });
                    
                    addLog('âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    // Check state
                    if (registration.active) {
                        addLog('ğŸŸ¢ Service Worker Ù†Ø´Ø·', 'success');
                    } else if (registration.installing) {
                        addLog('ğŸ”„ Service Worker Ù‚ÙŠØ¯ Ø§Ù„ØªØ«Ø¨ÙŠØª...', 'info');
                    } else if (registration.waiting) {
                        addLog('â³ Service Worker ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'warning');
                    }
                    
                    // Wait for ready
                    await navigator.serviceWorker.ready;
                    addLog('ğŸ¯ Service Worker Ø¬Ø§Ù‡Ø²!', 'success');
                    
                } catch (error) {
                    addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Service Worker: ${error.message}`, 'error');
                }
            } else {
                addLog('âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error');
            }
        }

        async function testPWACriteria() {
            addLog('ğŸ“‹ ÙØ­Øµ Ù…Ø¹Ø§ÙŠÙŠØ± PWA...', 'info');
            
            const criteria = {
                'HTTPS': location.protocol === 'https:',
                'Service Worker': 'serviceWorker' in navigator,
                'Web Manifest': document.querySelector('link[rel="manifest"]') !== null,
                'Icons': false,
                'Display Mode': false,
                'Start URL': false
            };
            
            // Test manifest details
            try {
                const manifestResponse = await fetch('/manifest.json', { cache: 'no-cache' });
                if (manifestResponse.ok) {
                    const manifest = await manifestResponse.json();
                    criteria['Icons'] = manifest.icons && manifest.icons.length >= 2;
                    criteria['Display Mode'] = manifest.display === 'standalone';
                    criteria['Start URL'] = !!manifest.start_url;
                }
            } catch (e) {
                addLog(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØ­Øµ Manifest: ${e.message}`, 'warning');
            }
            
            // Display results
            for (const [criterion, passed] of Object.entries(criteria)) {
                const status = passed ? 'success' : 'error';
                const icon = passed ? 'âœ…' : 'âŒ';
                addLog(`${icon} ${criterion}: ${passed ? 'ÙŠØªØ·Ø§Ø¨Ù‚' : 'Ù„Ø§ ÙŠØªØ·Ø§Ø¨Ù‚'}`, status);
            }
            
            const passedCount = Object.values(criteria).filter(Boolean).length;
            const totalCount = Object.keys(criteria).length;
            
            if (passedCount === totalCount) {
                addLog('ğŸ‰ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ø§ÙŠÙŠØ± PWA!', 'success');
                addLog('ğŸ’¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­', 'info');
            } else {
                addLog(`âš ï¸ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ${passedCount}/${totalCount} Ù…Ø¹Ø§ÙŠÙŠØ±`, 'warning');
            }
        }

        async function forceInstallPrompt() {
            addLog('ğŸ“± Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¬Ø¨Ø§Ø± Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª...', 'info');
            
            if (installPromptEvent) {
                try {
                    const result = await installPromptEvent.prompt();
                    addLog('ğŸ¯ ØªÙ… Ø¹Ø±Ø¶ prompt Ù„Ù„ØªØ«Ø¨ÙŠØª', 'success');
                    
                    const choiceResult = await result.userChoice;
                    if (choiceResult.outcome === 'accepted') {
                        addLog('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ØªØ«Ø¨ÙŠØª!', 'success');
                    } else {
                        addLog('â¸ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„ØªØ«Ø¨ÙŠØª', 'info');
                    }
                    installPromptEvent = null;
                } catch (error) {
                    addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Install Prompt: ${error.message}`, 'error');
                }
            } else {
                addLog('âŒ Install Prompt ØºÙŠØ± Ù…ØªÙˆÙØ±', 'error');
                addLog('ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± PWA Ø£ÙˆÙ„Ø§Ù‹', 'info');
                
                // Try to trigger by reloading
                addLog('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªØ­ÙÙŠØ² Install Prompt...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

        async function clearEverything() {
            addLog('ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            try {
                // Unregister service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        addLog(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡: ${registration.scope}`, 'success');
                    }
                }
                
                // Clear caches
                const cacheNames = await caches.keys();
                for (let cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    addLog(`âœ… ØªÙ… Ø­Ø°Ù cache: ${cacheName}`, 'success');
                }
                
                // Clear storage
                localStorage.clear();
                sessionStorage.clear();
                addLog('âœ… ØªÙ… Ù…Ø³Ø­ Storage', 'success');
                
                addLog('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            addLog('ğŸ¯ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± PWA Ø¬Ø§Ù‡Ø²Ø©', 'info');
            addLog('ğŸ‘† Ø§Ø¨Ø¯Ø£ Ø¨Ù€ "Ø§Ø®ØªØ¨Ø§Ø± Manifest" Ø«Ù… "ÙØ­Øµ Ù…Ø¹Ø§ÙŠÙŠØ± PWA"', 'info');
        });

        // Listen for app installed
        window.addEventListener('appinstalled', (evt) => {
            addLog('ğŸ‰ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        });
    </script>
</body>
</html>